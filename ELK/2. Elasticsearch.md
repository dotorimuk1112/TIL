# Elasticsearch

ë¶„ë¥˜: ELK
[Notionì—ì„œ ë³´ê¸°](https://www.notion.so/Elasticsearch-68ee6a3950e14dfd95ad03620aa603b6)

# â†“ Elasticsearch ê°œìš” â†“

[ELK_introduction](https://www.notion.so/ELK_introduction-4c61592ed24d453f8835345e9d599b2b?pvs=21)

# Elasticsearch íŠ¹ì§•

- **NoSQL**
    - ElasitcsearchëŠ” ê²€ìƒ‰ì—”ì§„ì´ì§€ë§Œ, NoSQL ë°ì´í„°ë¥¼ ì €ì¥í•˜ì—¬ ì´ë“¤ì„ ê²€ìƒ‰í•˜ëŠ” í˜•íƒœê¸°ì—, ë‹¹ì—°íˆë„ NoSQLì˜ íŠ¹ì„± ì—­ì‹œ ê°€ì§€ê³  ìˆìŒ.
    
    | ì—˜ë¼ìŠ¤í‹±ì„œì¹˜ | MYSQL ë“±ì˜ ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤(RDBMS) |
    | --- | --- |
    | ì¸ë±ìŠ¤ | ë°ì´í„°ë² ì´ìŠ¤ |
    | ìƒ¤ë“œ | íŒŒí‹°ì…˜ |
    | íƒ€ì… | í…Œì´ë¸” |
    | ë¬¸ì„œ | í–‰ |
    | í•„ë“œ | ì—´ |
    | ë§¤í•‘ | ìŠ¤í‚¤ë§ˆ |
    | Query DSL | SQL |
    - Elasticsearchì—ëŠ” í•˜ë‚˜ì˜ ì¸ë±ìŠ¤ì— í•˜ë‚˜ì˜ íƒ€ì…ë§Œì„ êµ¬ì„±í•  ìˆ˜ ìˆìŒ.
    - ë˜í•œ ê¸°ë³¸ì ìœ¼ë¡œ HTTPë¥¼ í†µí•´ json í˜•ì‹ì˜ Restful APIë¥¼ ì‚¬ìš©
- **ì „ë¬¸ ê²€ìƒ‰(Full Text Search)**
    - RDBMSì—ì„œëŠ” whereë¬¸ì— â€˜columnâ€™=â€™valueâ€™ í˜•íƒœë¡œ íŠ¹ì • í•„ë“œë¥¼ ì§€ì •í•´ì•¼ í•˜ì§€ë§Œ, ElasticsearchëŠ” ì—¬ëŸ¬ ê°œì˜ í•„ë“œë¥¼ í•¨ê»˜ ìƒ‰ì¸í•´ì„œ ì „ì²´ì—ì„œ íŠ¹ì • ë‹¨ì–´ë¥¼ ê²€ìƒ‰í•˜ëŠ” ê²ƒì´ ê°€ëŠ¥í•¨.
- **í†µê³„ ë¶„ì„ ê¸°ëŠ¥**
    - ë¹„ì •í˜• ë¡œê·¸ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ê³  Kibanaë¥¼ ì´ìš©í•´ í†µê³„ ë¶„ì„ì´ ê°€ëŠ¥í•¨.
    ìµœê·¼ 8 ë²„ì „ ì´ìƒì—ì„œ ë¨¸ì‹ ëŸ¬ë‹ ë“± ì¶”ê°€ì ì¸ ë¶„ì„ ë„êµ¬ ì§€ì›
- **Multi-tenancy**
    - ê²€ìƒ‰í•  í•„ë“œë¡œ ì—¬ëŸ¬ ê°œì˜ ì¸ë±ìŠ¤ë¥¼ í•œ ë²ˆì— ì¡°íšŒ ê°€ëŠ¥
- **ì—­ìƒ‰ì¸(inverted index)**
    - ì—­ìƒ‰ì¸ êµ¬ì¡°ë¥¼ í†µí•´ íŠ¹ì • ë‹¨ì–´ ê²€ìƒ‰ ì‹œ ë¬¸ì„œ ì „ì²´ê°€ ì•„ë‹ˆë¼ ë‹¨ì–´ê°€ í¬í•¨ëœ íŠ¹ì • ë¬¸ì„œë¥¼ ì•Œì•„ë‚´ ë§¤ìš° ë¹ ë¥¸ ê²€ìƒ‰ ì†ë„ë¥¼ ìë‘í•¨
    - ë‹¤ë§Œ ë°ì´í„°ì˜ ì…ë ¥ê³¼ ë™ì‹œì— ì—­ìƒ‰ì¸ì„ ìƒì„±í•˜ê¸°ì— ë°ì´í„°ì˜ ì…ë ¥, ìƒì„± ì†ë„ê°€ ë‹¤ì†Œ ëŠë¦´ ìˆ˜ ìˆìŒ
- **ë¶„ì‚° í™˜ê²½**
    - Cluster > Node > Shard > Document > Field
    - Elasticsearchì—ì„œëŠ” ë°ì´í„°ë¥¼ ì—¬ëŸ¬ Fieldë¡œ êµ¬ì„±ëœ documentë¼ëŠ” json í˜•íƒœë¡œ ì €ì¥.ì´ documentë“¤ì€ ë‹¤ì‹œ Shardë¼ëŠ” ì‘ì€ ë‹¨ìœ„ë¡œ ë‚˜ëˆ„ì–´ ì œê³µí•˜ì—¬ ë°ì´í„°ë¥¼ ë¶„ì‚°í•˜ì—¬ ë¹ ë¥´ê²Œ ì²˜ë¦¬í•¨.
    - ë˜í•œ ê° ìƒ¤ë“œë“¤ì€ ì›ë³¸ê³¼ ì—¬ëŸ¬ ê°œì˜ ë³µì œë³¸(replica)ìœ¼ë¡œ ë‚˜ë‰¨.
        - ì´ ë³µì œë³¸ë“¤ì€ ì•„ë˜ ì‚½í™”ì™€ ê°™ì´ ì›ë³¸ê³¼ ë‹¤ë¥¸ Indexì— ì €ì¥ë˜ì–´ 
        ì„œë²„ì˜ ì˜ˆê¸°ì¹˜ ëª»í•œ shutdownì´ë‚˜ ë°ì´í„°ì˜ ì†Œì‹¤ ë“±ì— ëŒ€ì‘ ê°€ëŠ¥
    - ì›ë³¸ê³¼ ë³µì œë³¸ì´ Indexê°€ ë˜ë©°, ì´ Indexë¥¼ nodeë¼ëŠ” Elasticsearchì˜ ì¸ìŠ¤í„´ìŠ¤ ë‹¨ìœ„ì— ë‚˜ëˆ„ì–´ ì €ì¥. ë‹¤ì‹œ ì´ nodeê°€ cluster ë‹¨ìœ„ë¡œ ìµœì¢… ê´€ë¦¬ë¨.
    
    ![Untitled](https://github.com/dotorimuk1112/TIL/blob/main/ELK/imgs2/Untitled.png)
    
- **ì¤€ì‹¤ì‹œê°„ ê²€ìƒ‰**
    - ElasticsearchëŠ” ë°ì´í„° ì €ì¥ ì‹œì ì— ë°ì´í„°ë¥¼ ìƒ‰ì¸í•˜ê¸° ì‹œì‘í•¨
    - ìƒ‰ì¸ëœ ë°ì´í„°ëŠ” ì•½ 1ì´ˆ ë’¤ë¶€í„° ê²€ìƒ‰ì´ ê°€ëŠ¥í•´ì ¸ì„œ ì™„ì „í•œ ì‹¤ì‹œê°„ ê²€ìƒ‰ì€ ë¶ˆê°€
    - ë‚´ë¶€ì ìœ¼ë¡œ commit, flushì™€ ê°™ì€ ë³µì¡í•œ ê³¼ì •ì„ ê±°ì¹¨
- **transaction, rollbackì´ ì—†ë‹¤**
    - Cluster ì„±ëŠ¥ í–¥ìƒì„ ìœ„í•´ ë¹„ìš© ì†Œëª¨ê°€ í° ë‘ ê¸°ëŠ¥ì„ íƒ‘ì¬í•˜ì§€ ì•ŠìŒ
    - ì‘ì„±/ìˆ˜ì •/ì‚­ì œ ì¦‰ì‹œ commit. ë”°ë¼ì„œ ë°ì´í„°ë¥¼ ë³´ë‹¤ ì¡°ì‹¬íˆ ë‹¤ë£° í•„ìš”ê°€ ìˆìŒ.

# Elasticsearch ê¸°ë³¸ í™˜ê²½ êµ¬ì„±

- Elasticsearch ì„¤ì¹˜
    - kibanaì™€ ë²„ì „ì´ ë°˜ë“œì‹œ ê°™ì•„ì•¼ í•¨

[Elasticsearchì™€ Kibanaì˜ ê°œë°œì‚¬ì¸ Elasticì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤](https://www.elastic.co/kr/)

- ì„¤ì¹˜ëœ Elasticsearch/config/Elasticsearch.yml ìˆ˜ì •
    
    ```yaml
    #config/elasticsearch.yml
    
    cluster.name: name-es
    node.name: name-es-node01
    
    path:
      data: dir\elk\elasticsearch\data
      logs: dir\elasticsearch\logs  
    
    network.host: 127.0.0.1
    
    discovery.type: "single-node"
    xpack.security.enabled: false
    ```
    

- config/jvm.optionsì˜ ì£¼ì„ì„ í•´ì œí•˜ê³  ì•„ë˜ì™€ ê°™ì´ ìˆ˜ì •
    
    ```yaml
    # config/jvm.options - ê¸°ë³¸ì ìœ¼ë¡œëŠ” ì‹œìŠ¤í…œ ë©”ëª¨ë¦¬ì˜ ì ˆë°˜ìœ¼ë¡œ ì§€ì •
    # config/jvm.options.d ë””ë ‰í† ë¦¬ ë°‘ì— ë³„ë„ íŒŒì¼ì„ ìƒˆë¡œ ìƒì„±í•´ì„œ í™ í¬ê¸°ë¥¼ ì§€ì •í•  ìˆ˜ë„ ìˆìŒ
    -Xms1g
    -Xmx1g
    ```
    

- í„°ë¯¸ë„ì—ì„œ ì„¤ì¹˜ ê²½ë¡œë¡œ ì´ë™ í›„ ì•„ë˜ ëª…ë ¹ì–´ ì‹¤í–‰
    
    ```bash
    # ìœˆë„ìš°
    $ bin\elasticsearch.bat
    
    # ë§¥
    $ bin/elasticsearch
    ```
    
- ì‹¤í–‰ í›„ ì›¹ì—ì„œ [localhost:9200](http://localhost:9200) ì£¼ì†Œë¡œ ì´ë™í•˜ì—¬ ì •ìƒ ì‹¤í–‰ ì—¬ë¶€ í™•ì¸
    
    ```
    {
      "name" : "name-es-node01",
      "cluster_name" : "name-es",
      "cluster_uuid" : "JvfbPfuaTfistOKJy61NIA",
      "version" : {
        "number" : "8.11.3",
        "build_flavor" : "default",
        "build_type" : "zip",
        "build_hash" : "64cf052f3b56b1fd4449f5454cb88aca7e739d9a",
        "build_date" : "2023-12-08T11:33:53.634979452Z",
        "build_snapshot" : false,
        "lucene_version" : "9.8.0",
        "minimum_wire_compatibility_version" : "7.17.0",
        "minimum_index_compatibility_version" : "7.0.0"
      },
      "tagline" : "You Know, for Search"
    }
    ```
    
- elasticsearch.ymlì—ì„œ data.logsë¡œ ì§€ì •í–ˆë˜ ë””ë ‰í† ë¦¬ë¡œ ì´ë™í•´ì„œ ë¡œê·¸ íŒŒì¼ì„ í™•ì¸í•´ startedê°€ í™•ì¸ë˜ë©´ elasticsearchê°€ ì‘ë™í•œ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŒ

- Kibana ì„¤ì¹˜
    - ë°˜ë“œì‹œ elasticsearchì™€ ë²„ì „ì´ ê°™ì•„ì•¼ í•¨
    
    [Download Kibana Free | Get Started Now](https://www.elastic.co/kr/downloads/kibana)
    

- config/kibana.yml ìˆ˜ì •
    
    ```bash
    server.port: 5601
    server.host: localhost
    server.publicBaseUrl: "http://localhost:5601"
    elasticsearch.hosts: ["http://localhost:9200"]
    ```
    

- í„°ë¯¸ë„ì—ì„œ kibana ì‹¤í–‰
    
    ```bash
    
    $ bin/kibana.bat
    
    # ë§¥ì—ì„œëŠ”
    $ bin\kibana
    ```
    
- ì‹¤í–‰ ì„±ê³µì‹œ **http://localhost:5601**ë¡œ Kibanaì— ì ‘ì†í•  ìˆ˜ ìˆìŒ
- Elasticsearch Tools Chrome extension
    - ì¶”ì²œ í”ŒëŸ¬ê·¸ì¸
    
    [Multi Elasticsearch Head](https://chrome.google.com/webstore/detail/multi-elasticsearch-head/cpmmilfkofbeimbmgiclohpodggeheim)
    
    [Elasticsearch Head í”ŒëŸ¬ê·¸ì¸(Chrome Extension)](https://realkoy.tistory.com/entry/Elasticsearch-Head-Chrome-Extension)
    

# Elasticsearch ê¸°ë³¸ ê¸°ëŠ¥

- REST APIë¥¼ í™œìš©í•˜ê¸°ì— CRUDë¥¼ ê°ê° ëª…ë ¹ì–´(API)ë¥¼ ë§Œë“¤ í•„ìš” ì—†ì´ [localhost:8000/post/1ì´ë¼ëŠ”](http://localhost:8000/post/1ì´ë¼ëŠ”) ë˜‘ê°™ì€ ì£¼ì†Œë¥¼ ê³µìœ í•´ ì‚¬ìš©í•œë‹¤
    - SQLê³¼ì˜ ëª…ë ¹ì–´ ë¹„êµ
        - CREATE == POST : ë°ì´í„° ì „ì²´ë¥¼ ì²¨ë¶€í•´ì„œ ì „ì†¡
        - READ(RETRIEVE) == GET, HEAD : ì²¨ë¶€í•˜ëŠ” ë°ì´í„° ì—†ìŒ.
        - UPDATE == PUT(ì „ì²´ ìˆ˜ì •): ìˆ˜ì • ê¸°ëŠ¥
            - PUTì€ CREATE ìš©ë„ë¡œë„ ì‚¬ìš©í•  ìˆ˜ ìˆìŒ
        - DELETE == DELETE
    

## ê¸°ë³¸ ë¬¸ë²•ê³¼ ì˜ˆì‹œ

### â–  CRUD

```json
**# CREATE
1) PUT**
PUT [ì¸ë±ìŠ¤ ì´ë¦„]/_doc/[_idê°’]  # IDê°’ì„ ì§ì ‘ ë¶€ì—¬
{
  [ë¬¸ì„œ ë‚´ìš©]
}

**ex)**
PUT idxname/_doc/1
{
  "title": "hello world",
  "views": 1234,
  "public": true,
  "created": "2019-01-17T14:05:01.234Z"
}

**2) POST**
POST [ì¸ë±ìŠ¤ ì´ë¦„]/
{
  IDìë™ìƒì„± [ë¬¸ì„œ ë‚´ìš©]
}

**ex)**
POST idxname/_doc/
{
  "student": {
    "name": "ì‹ ì§±êµ¬", #student.nameìœ¼ë¡œ ë©”ëª¨ë¦¬ì— ì˜¤ë¦„
    "age": 5
  }
}
```

```json

**# READ(RETRIEVE)**
GET [ì¸ë±ìŠ¤ ì´ë¦„]/_doc/[_idê°’]

**ex) _search api ì‚¬ìš©**
GET idxname/_doc/1

```

```json
**# UPDATE**
POST [ì¸ë±ìŠ¤ ì´ë¦„]/_update/[_idê°’]
{
  "doc": {
    "í•„ë“œëª…(ì»¬ëŸ¼ëª…)": "ìˆ˜ì •í•  ë‚´ìš©"
  }
}

******ex)******
POST my_index/_update/1
{
  "doc": {
    "title": "hello elasticsearch!"
  }
}
```

```json

**# DELETE** 
DELETE [ì¸ë±ìŠ¤ ì´ë¦„]/_doc/[_idê°’]
```

### â–  ê²€ìƒ‰

- ê²€ìƒ‰ APIëŠ” GETê³¼ POST ë‘˜ ë‹¤ ì‚¬ìš©í•´ë„ ë™ì¼í•˜ê²Œ ì •ìƒ ì‘ë™.
    
    ```jsx
    
    GET [ì¸ë±ìŠ¤ ì´ë¦„]/_search
    POST [ì¸ë±ìŠ¤ ì´ë¦„]/_search
    
    ****************************************************# title í•„ë“œì— 'hello world'ë¼ëŠ” ê°’ì„ ê°–ëŠ” document ê²€ìƒ‰****************************************************
    GET my_index/_search
    {
      "query": {
        "match": {
          "title": "hello world"
        }
      }
    }
    ```
    

### â–  ì¸ë±ìŠ¤ ê´€ë¦¬

- ëª¨ë“  ì¸ë±ìŠ¤ëŠ” settingsì™€ mappingsë¼ëŠ” ë‘ ê°œì˜ ì •ë³´ ë‹¨ìœ„ë¥¼ ê°€ì§.
    
    <aside>
    ğŸ’¡ Setting
    ì¸ë±ìŠ¤ì˜ ê¸°ë³¸ ì •ë³´ë“¤ê³¼ ì„¤ì •ê°’ì„ í¬í•¨í•˜ëŠ” ì •ë³´.
    ìƒ¤ë“œì˜ ìˆ˜, ì¸ë±ìŠ¤ ì´ë¦„, UNIX timestamp(1970ë…„ 1ì›” 1ì¼ë¶€í„° ì§€ë‚œ ì‹œê°„ì„ ì´ˆë¡œ í‘œê¸°í•˜ëŠ” ì‹œê°„ ë‹¨ìœ„) ë“±ì„ í¬í•¨
    
    </aside>
    
    <aside>
    ğŸ’¡ Mapping
    ë¬¸ì„œê°€ ì¸ë±ìŠ¤ì— ì–´ë–»ê²Œ ìƒ‰ì¸ë˜ê³  ì €ì¥ë˜ëŠ”ì§€ ì •ì˜í•˜ëŠ” ë¶€ë¶„. SQLì˜ ìë£Œí˜•ê³¼ ìœ ì‚¬
    
    </aside>
    
    - **ì˜ˆì‹œ ì½”ë“œ**
        
        ```json
        ******# ì˜ˆì‹œë¡œ ë§Œë“  ì¸ë±ìŠ¤ì˜ ì •ë³´******
        {
          "my_index": {
            "aliases": {},
            "mappings": {
              "properties": {
                "created": {
                  "type": "date"
                },
                "public": {
                  "type": "boolean"
                },
                "title": {
                  "type": "text",
                  "fields": {
                    "keyword": {
                      "type": "keyword", # ë°ì´í„° íƒ€ì…
                      "ignore_above": 256
                    }
                  }
                },
                "views": {
                  "type": "long"
                }
              }
            },
            "settings": {
              "index": {
                "routing": {
                  "allocation": {
                    "include": {
                      "_tier_preference": "data_content"
                    }
                  }
                },
                "number_of_shards": "1", # ìƒ¤ë“œì˜ ìˆ˜
                "provided_name": "my_index", # ì´ë¦„
                "creation_date": "1703643578682", # UNIX timestamp
                "number_of_replicas": "1",
                "uuid": "daeRpFK4RrmJK5Q2UW9k6Q",
                "version": {
                  "created": "8500003"
                }
              }
            }
          }
        }
        ```
        
    
- ë™ì  ë§µí•‘ê³¼ ëª…ì‹œì  ë§µí•‘
    - **ë™ì  ë§¤í•‘ (Dynamic Mapping):**
        - **ìë™ ìƒì„±:** ë™ì  ë§¤í•‘ì€ Elasticsearchê°€ ë°ì´í„°ë¥¼ ìƒ‰ì¸í™”í•  ë•Œ í•„ë“œë¥¼ ìë™ìœ¼ë¡œ ìƒì„±. ì˜ˆë¥¼ ë“¤ì–´, ìƒˆë¡œìš´ ì¸ë±ìŠ¤ì— ë¬¸ì„œë¥¼ ì¶”ê°€í•  ë•Œ ElasticsearchëŠ” ë¬¸ì„œì˜ ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬ í•„ë“œë¥¼ ìë™ìœ¼ë¡œ ìƒì„±.
        - **ìœ ì—°ì„±:** ìƒˆë¡œìš´ í•„ë“œê°€ ë‚˜íƒ€ë‚˜ë©´ ElasticsearchëŠ” ìë™ìœ¼ë¡œ í•´ë‹¹ í•„ë“œì— ëŒ€í•œ ë§¤í•‘ì„ ìƒì„±. ì´ëŠ” ë°ì´í„°ê°€ ë™ì ìœ¼ë¡œ ë³€ê²½ë˜ëŠ” ê²½ìš° íŠ¹íˆ ìœ ìš©.
        - **ìœ„í—˜ì„±:** ë™ì  ë§¤í•‘ì€ Elasticsearchê°€ ìë™ìœ¼ë¡œ í•„ë“œë¥¼ ë§¤í•‘í•˜ë¯€ë¡œ ì˜ë„í•˜ì§€ ì•Šì€ ë§¤í•‘ì´ ë°œìƒí•  ìˆ˜ ìˆìŒ. ì˜ëª»ëœ ë§¤í•‘ì´ ë°ì´í„°ì˜ ì¼ê´€ì„±ì„ í•´ì¹  ìˆ˜ ìˆìŒ.
    - **ëª…ì‹œì  ë§¤í•‘ (Explicit Mapping):**
        - **ìˆ˜ë™ ì •ì˜:** ëª…ì‹œì  ë§¤í•‘ì€ ì‚¬ìš©ìê°€ í•„ë“œì— ëŒ€í•œ ë§¤í•‘ì„ ì§ì ‘ ì •ì˜í•˜ëŠ” ê²ƒ. ì¸ë±ìŠ¤ë¥¼ ìƒì„±í•  ë•Œ ë¯¸ë¦¬ ì •ì˜ëœ ë§¤í•‘ì„ ì‚¬ìš©í•˜ê±°ë‚˜, ê¸°ì¡´ ì¸ë±ìŠ¤ì— ìƒˆë¡œìš´ í•„ë“œë¥¼ ì¶”ê°€í•  ë•Œ ëª…ì‹œì ìœ¼ë¡œ ë§¤í•‘ì„ ì§€ì •í•  ìˆ˜ ìˆìŒ.
        - **ì œì–´ ê°€ëŠ¥ì„±:** ì‚¬ìš©ìëŠ” ë°ì´í„° ëª¨ë¸ì„ ëª…ì‹œì ìœ¼ë¡œ ì œì–´í•  ìˆ˜ ìˆìŒ. í•„ë“œ ìœ í˜•, ë¶„ì„ê¸°, í¬ë§· ë“±ì„ ì •ì˜í•˜ì—¬ ë°ì´í„°ì˜ êµ¬ì¡°ì™€ í˜•ì‹ì„ ëª…í™•í•˜ê²Œ ì§€ì •í•  ìˆ˜ ìˆìŒ.
        - **ì•ˆì •ì„±:** ëª…ì‹œì  ë§¤í•‘ì€ ì‚¬ìš©ìê°€ ë°ì´í„° êµ¬ì¡°ë¥¼ ë”ìš± ì•ˆì •ì ìœ¼ë¡œ ê´€ë¦¬ ê°€ëŠ¥. ì˜ë„ì¹˜ ì•Šì€ ë§¤í•‘ ë³€í™”ë¥¼ ë°©ì§€.

### â–  ë°°ì—´

- Elasticsearchì—ëŠ” ë³„ë„ì˜ ë°°ì—´ êµ¬ë¬¸ì´ ì—†ìŒ.
ë‹¨ì¼ ìˆ«ì ë°ì´í„°ë¥¼ long íƒ€ì… í•„ë“œì— ë„£ì„ ìˆ˜ë„ ìˆê³  [1, 2, 3]ì²˜ëŸ¼ ì—¬ëŸ¬ ê°œë¡œ ì´ë£¨ì–´ì§„ í˜•íƒœì˜ ë°ì´í„°ë„ ë„£ì„ ìˆ˜ ìˆìŒ.
    - **ì˜ˆì‹œ ì½”ë“œ**
        
        ```json
        **# long/keyword íƒ€ì… í™•ì¸**
        PUT array_test
        	{
        		"mappings": {
        			"properties": {
        				"longField": {
        				"type": "long"
        				},
        				"keywordField": {
        					"type": "keyword"
        				}
        			}
        		}
        }
        
        **# ì…ë ¥**
        PUT array_test/_doc/1
        {
          "longFiled": [123, 1, 2, 3]
          "keywordFiled": ["this", "is", "it"]
        }
        
        **# ì¶œë ¥**
        {
          "_index": "array_test",
          "_id": "1",
          "_version": 4,
          "_seq_no": 8,
          "_primary_term": 6,
          "found": true,
          "_source": {
            "longFiled": [
              123,
              1,
              2,
              3
            ],
            "keywordFiled": [
              "this",
              "is",
              "it"
            ]
          }
        }
        ```
        

# Elasticsearch ê²€ìƒ‰ API

![Untitled](https://github.com/dotorimuk1112/TIL/blob/main/ELK/imgs2/Untitled%201.png)

![Untitled](https://github.com/dotorimuk1112/TIL/blob/main/ELK/imgs2/Untitled%202.png)

### â–  ê²€ìƒ‰ì„ ìœ„í•œ query: match / term

- match query: ì¿¼ë¦¬ ìˆ˜í–‰ ì „ ë¶„ì„ê¸°ë¥¼ í†µí•´ textë¥¼ ë¶„ì„í•œ í›„ ê²€ìƒ‰ ìˆ˜í–‰
- term query: ë³„ë„ì˜ ë¶„ì„ ì‘ì—… ì—†ì´ ì…ë ¥ëœ textê°€ ì¡´ì¬í•˜ëŠ” doc ê²€ìƒ‰
    - keyword ë°ì´í„° íƒ€ì…ì„ ì‚¬ìš©í•˜ëŠ” field ê²€ìƒ‰ ì‹œ ì‚¬ìš©
    - keyword íƒ€ì… ê²€ìƒ‰ ì˜ˆì‹œ
        
        ```json
        **# í‚¤ì›Œë“œ íƒ€ì… ê²€ìƒ‰**
        POST woorifisa/_doc/1
        ****{
          "student": {
            "name": "ì‹  ì§±êµ¬",
            "age": 5
          }
        }
        ****
        GET woorifisa/_search
        {
          "query": {
            "match": {
              "student.name.keyword": "ì§±êµ¬"
            }
          }
        }
        
        **# ì¶œë ¥ ê²°ê³¼: keyword íƒ€ì…ì€ "ì‹  ì§±êµ¬"ë¥¼ í•œ ë©ì–´ë¦¬ë¡œ ì¸ì‹í•˜ëŠ”
        	íƒ€ì…ì´ê¸°ì— ì¤‘ê°„ êµ¬ì„± ìš”ì†Œì¸ "ì§±êµ¬"ë¥¼ ì…ë ¥í•˜ë©´ ê²€ìƒ‰ì´ ë¶ˆê°€**
        {
          "took": 0,
          "timed_out": false,
          "_shards": {
            "total": 1,
            "successful": 1,
            "skipped": 0,
            "failed": 0
          },
          "hits": {
            "total": {
              "value": 0,
              "relation": "eq"
            },
            "max_score": null,
            "hits": []
          }
        }
        ```
        

### â–  Query DSL

- Full text query: ì „ì²´ ì¡°ê±´ì´ ë“¤ì–´ë§ëŠ” ê²½ìš°ì— ë¶„ì„ëœ text fieldë¥¼ ê²€ìƒ‰
    
    ![Screen Shot 2023-06-28 at 8.25.49 AM.png](Elasticsearch%2068ee6a3950e14dfd95ad03620aa603b6/Screen_Shot_2023-06-28_at_8.25.49_AM.png)
    
- bool query
    - RDBì˜ whereì ˆê³¼ í¡ì‚¬(ìƒì„¸í•œ ì¡°ê±´ì„ í†µí•œ ê²€ìƒ‰)
    - ê¸°ë³¸ ë¬¸ë²•
        
        
        | êµ¬ë¬¸ | SQLì—ì„œ | ì„¤ëª… |
        | --- | --- | --- |
        | must | col = ì¡°ê±´ | ë°˜ë“œì‹œ ì¡°ê±´ì— ë§Œì¡±í•˜ëŠ” ë¬¸ì„œë§Œ ê²€ìƒ‰ |
        | must_not | col != ì¡°ê±´ | ì¡°ê±´ì„ ë§Œì¡±í•˜ì§€ ì•ŠëŠ” ë¬¸ì„œ ê²€ìƒ‰ |
        | should | or col = ì¡°ê±´ | ê²€ìƒ‰ ì ìˆ˜ ì¡°ì ˆí•˜ê¸° ìœ„í•´ ì‚¬ìš©
        ì¡°ê±´ì„ ë§Œì¡±í•˜ì§€ ëª»í•œë‹¤ê³  í•´ì„œ ê²°ê³¼ê°€ ì•ˆ ë‚˜ì˜¤ëŠ” ê²ƒì€ ì•„ë‹ˆì§€ë§Œ ì¡°ê±´ì„ ë§Œì¡±í•˜ë©´ ë” ìƒìœ„ì— ê²€ìƒ‰ë¨ |
        | filter | col in (ì¡°ê±´) | ì¡°ê±´ì„ í¬í•¨í•˜ê³  ìˆëŠ” ë¬¸ì„œ ê²€ìƒ‰ |
        
        ```json
        **# must: customersê°€ 3964.25 ì´ìƒì¸ í•„ë“œ ê²€ìƒ‰**
        GET bank/_search
        {
          "query": {
            "bool": {
              "must": [
                {"range": {
                  "customers": {
                    "gte": 3964.25
                  }
                }
               }
              ]
            }
          }
        }
        ```
        
        ```json
        **# must_not: customersê°€ 3964.25 ì´ìƒì´ ì•„ë‹Œ í•„ë“œ ê²€ìƒ‰** 
        GET bank/_search
        {
          "query": {
            "bool": {
              "must": [
                {"range": {
                  "customers": {
                    "gte": 3964.25
                  }
                }
               }
              ]
            }
          }
        }
        ```
        
        ```json
        **# should: pinkê°€ ë“¤ì–´ê°€ë˜ blueê°€ ê°™ì´ ë“¤ì–´ìˆëŠ” ê²½ìš°
        ê°€ì¤‘ì¹˜ ë¶€ì—¬ (blueê°€ ì—†ëŠ” ê²½ìš°ëŠ” í›„ìˆœìœ„ë¡œ ê²€ìƒ‰)**
        GET my_bulk/_search
        {
          "query": {
            "bool": {
              "must": [
                {
                  "match": {
                    "message": "pink"
                  }
                }
              ],
              "should": [
                {
                  "match": {
                    "message": "blue"
                  }
                }
              ]
            }
          }
        }
        ```
        
        ```json
        **# filter: customersê°€ 3964.25 ì´ìƒì¸ í•„ë“œë¥¼ ê²€ìƒ‰í•˜ì§€ë§Œ
        ê°€ì¤‘ì¹˜ ë¯¸ë¶€ì—¬**
        GET bank/_search
        {
          "query": {
            "bool": {
              "filter": [
                {"range": {
                  "customers": {
                    "gte": 3964.25
                  }
                }
               }
              ]
            }
          }
        }
        ```
        

# Elasticsearchí…ìŠ¤íŠ¸ ë¶„ì„

- Analyzer, normalizerì˜ ê¸°ë³¸ êµ¬ì¡°

![**text íƒ€ì…ê³¼ keyword íƒ€ì…ì˜ ìƒ‰ì¸ ê³¼ì •. ì¶œì²˜ <ì—˜ë¼ìŠ¤í‹± ì„œì¹˜ ë°”ì´ë¸”>, ìœ„í‚¤ë¶ìŠ¤**](https://github.com/dotorimuk1112/TIL/blob/main/ELK/imgs2/Untitled%203.png)

**text íƒ€ì…ê³¼ keyword íƒ€ì…ì˜ ìƒ‰ì¸ ê³¼ì •. ì¶œì²˜ <ì—˜ë¼ìŠ¤í‹± ì„œì¹˜ ë°”ì´ë¸”>, ìœ„í‚¤ë¶ìŠ¤**

- **Analyzer**
    - Text analysis ê³¼ì •ì„ ì²˜ë¦¬í•˜ëŠ” ê¸°ëŠ¥
    - ìºë¦­í„° í•„í„° â†’ í† í¬ë‚˜ì´ì € â†’ í† í° í•„í„° ìˆœìœ¼ë¡œ êµ¬ì„±/ì‘ë™
    - **ìºë¦­í„° í•„í„°**: ì…ë ¥ ë°ì´í„°ë¥¼ ì „ì²´ ë¬¸ì¥ì—ì„œ ì§€ì •ëœ ë¬¸ìë¡œ
    ëŒ€ì²´í•˜ê±°ë‚˜ ì œê±°í•˜ëŠ” ê³¼ì •
    - **í† í¬ë‚˜ì´ì €**: ë¬¸ì¥ì„ term ë‹¨ìœ„ë¡œ í•˜ë‚˜ì”© ë¶„ë¦¬í•˜ëŠ” ê³¼ì •
    - **í† í° í•„í„°**: ê³µë°±ì„ ê¸°ì¤€ìœ¼ë¡œ ë‚˜ë‰œ termë“¤ì„ í•˜ë‚˜ì”© ê°€ê³µí•˜ëŠ” ê³¼ì •
    
    **ê¸°ë³¸ ë‚´ì¥ analyzer**
    
    | ì´ë¦„ | ì„¤ëª… |
    | --- | --- |
    | standard | standard í† í¬ë‚˜ì´ì €/ lowercase í† í° í•„í„°ë¡œ êµ¬ì„± |
    | whitespace | ê³µë°± ë¬¸ì ë‹¨ìœ„ë¡œ í† í° ë¶„ë¦¬ |
    | stop | standardì™€ ë™ì¼í•˜ì§€ë§Œ stop í† í° í•„í„°ë¥¼ ì‚¬ìš©í•´
    ë¶ˆìš©ì–´ ì œê±° |
    | keyword | ë¶„ì„ì„ ìˆ˜í–‰í•˜ì§€ ì•Šê³  í•˜ë‚˜ì˜ í° í† í°ìœ¼ë¡œ ë°˜í™˜ |
    | fingerprint | standard ì ìš© í›„, lowercase ì ìš©
    ASCII folding í† í° í•„í„°, stop í† í° í•„í„° ì ìš©
    ê·¸ í›„ fingerprint í† í° í•„í„° ì ìš©
    ê²°ê³¼: ASCII ë¬¸ìë¡œ ë³€í™˜ ì¤‘ë³µê°’ì„ ì œê±°í•˜ê³ 
    ì•ŒíŒŒë²³ìˆœìœ¼ë¡œ ì •ë ¬ |
    

# ì§‘ê³„(aggregation) API

**Elasticsearchì˜ ì§‘ê³„ëŠ” ê²€ìƒ‰ì„ ë¨¼ì € ìˆ˜í–‰í•˜ê³  ê²€ìƒ‰ ê²°ê³¼ë§Œ ì§‘ê³„í•˜ëŠ”
ë°©ì‹ìœ¼ë¡œ ì‘ë™**

- Metric ì§‘ê³„(sum, avg, max, min)
    - ë¬¸ì„œì— ëŒ€í•œ ì‚°ìˆ ì  ì—°ì‚°ì„ ì‹œí–‰
    
    ```json
    **# ì§€ì—­ëª…ì´ "ì„œìš¸"ì¸ í…Œì´ë¸”ì˜ ê³ ê° í•„ë“œì˜ í•©ê³„ ì§‘ê³„**
    GET idx/_search
    {
      "query": {
        "match": {
          "location": "ì„œìš¸"
        }
      },
      "size": 0,
      "aggs": 
        "ê³ ê°ìˆ˜":
        {
          "sum":
          {
            "field": "customers"
          }
        }
      }
    }
    ```
    

- ë²„í‚· ì§‘ê³„
    - ë¬¸ì„œë¥¼ íŠ¹ì • ê¸°ì¤€ìœ¼ë¡œ ìª¼ê°œì–´ ì—¬ëŸ¬ ë¶€ë¶„ìœ¼ë¡œ ë‚˜ëˆˆ ê²ƒì˜ ë¶€ë¶„ ì§‘í•©ì„ ë²„í‚·ì´ë¼ê³  í•¨.
    - ê° ë²„í‚·ì— í¬í•¨ëœ ë¬¸ì„œë¥¼ ëŒ€ìƒìœ¼ë¡œ ë³„ë„ì˜ í•˜ìœ„ ì§‘ê³„ë¥¼ ìˆ˜í–‰
    
    ```json
    **# "distance-kilometers-range"ë¥¼ ë¨¼ì € íŠ¹ì • êµ¬ê°„ë³„ë¡œ ë‚˜ëˆ„ê³ 
    # ë‚˜ëˆˆ êµ¬ê°„ë§ˆë‹¤ "AvgTicketPrice"ì— ëŒ€í•´ í‰ê·  ì§‘ê³„
    # íŠ¹ì • êµ¬ê°„ìœ¼ë¡œ ë‚˜ëˆ„ëŠ” ì§‘ê³„ê°€ ë²„í‚· ì§‘ê³„**
    GET kibana_sample_data_flights/_search
    {
      "size": 0,
      "query": {
        "match_all": {}
      },
      "aggs": {
        "distance-kilometers-range": {
          "range": {
            "field": "DistanceKilometers",
            "ranges": [
              {
                "to": 5000
              },
              {
                "from": 5000,
                "to": 10000
              },
              {
                "from": 10000
              }
            ]
          },
          "aggs": {
            "average-ticket-price": {
              "avg": {
                "field": "AvgTicketPrice"
              }
            }
          }
        }
      }
    }
    ```
    

- terms ì§‘ê³„
    - ì§‘ê³„ì‹œ ì§€ì •í•œ í•„ë“œì— ëŒ€í•´ ë¹ˆë„ìˆ˜ê°€ ë†’ì€ terms ìˆœìœ„ ë°˜í™˜
    - ì˜ˆ) ê°€ì¥ ë§ì´ ì ‘ì†í•˜ëŠ” ì‚¬ìš©ì
    
    ```json
    **# host í•„ë“œì— ëŒ€í•´ì„œ ìœ ë‹ˆí¬í•œ ê°’ë“¤ì„ ì¶”ì¶œí•˜ê³ ,
    # ê° ê°’ë“¤ì— ëŒ€í•œ ë¬¸ì„œ ìˆ˜ë¥¼ ì„¼ë‹¤.**
    GET kibana_sample_data_logs/_search
    {
      "size": 0,
      "query": {
        "match_all": {}
    },
    "aggs": {
        "my-terms-aggs": {
          "terms": {
            "field": "host.keyword",
            "size": 10
          }
        }
      }
    }
    ```
    
- cumulative ì§‘ê³„
    - ì£¼ì–´ì§„ ë°ì´í„°ì˜ ëˆ„ì ê°’ì„ ê³„ì‚°í•˜ëŠ” ê¸°ëŠ¥
    - íŠ¹ì • ìˆœì„œë¡œ ëœ ë°ì´í„°ì— ëŒ€í•´ ê° í•­ëª©ê¹Œì§€ ëˆ„ì  ê°’ ë°˜í™˜
    
    ```json
    GET kibana_sample_data_ecommerce/_search
    {
      "size": 0,
      "query": {
        "match_all": {}
      },
      "aggs": {
        "daily-timestamp-bucket": {
          "date_histogram": {
            "field": "order_date",
            "calendar_interval": "day"
          },
          "aggs": {
            "daily-total-quantity-average": {
              "avg": {
                "field": "total_quantity"
              }
            },
            "pipeline-sum": {
              "cumulative_sum": {
                "buckets_path": "daily-total-quantity-average"
              }
            }
          }
        }
      }
    }
    ```